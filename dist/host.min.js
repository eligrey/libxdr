/*! @source https://github.com/Financial-Times/ft-xdr/blob/master/src/pmxdr-host.js*/
(function(undef){"use strict";var alwaysTrustedOrigins=[/^https?:\/\/[\w\-]+\.ft\.com$/i];function cleanHeader(dirty){if(typeof dirty!=="string"){return""}var clean;clean=dirty.replace(/[ \n\r\t]/g,"").toUpperCase();return clean}function getAllHeaders(request){var headers,header,i,responseHeaders;headers={};responseHeaders=request.getAllResponseHeaders().split(/\r?\n/);for(i=0;i<responseHeaders.length;i+=1){header=responseHeaders[i].split(": ");headers[header[0].toLowerCase()]=header[1]}return headers}function getHeader(request,name){try{return request.getResponseHeader(name)}catch(e){return""}}function getCorsHeaders(request){return{origin:getHeader(request,"Access-Control-Allow-Origin"),methods:getHeader(request,"Access-Control-Allow-Methods")}}function isAllowedMethod(method,headerValue){headerValue=cleanHeader(headerValue);if(!headerValue||headerValue==="*"){return true}headerValue=","+headerValue+",";if(headerValue.indexOf(","+method+",")!==-1){return true}return false}function isAlwaysTrusted(origin){var i,isTrusted;for(i=0;i<alwaysTrustedOrigins.length;i+=1){if(alwaysTrustedOrigins[i]instanceof RegExp){isTrusted=alwaysTrustedOrigins[i].test(origin)}else if(typeof alwaysTrustedOrigins[i]==="string"){isTrusted=origin===alwaysTrustedOrigins[i]}if(isTrusted){return true}}return false}function isTrustedOrigin(origin,headerValue){origin=origin.toUpperCase();if(isAlwaysTrusted(origin)){return true}headerValue=cleanHeader(headerValue);if(headerValue==="*"||headerValue===origin){return true}return false}function makeRequest(method,uri,headers,data,callback){var header,request;request=new XMLHttpRequest;request.open(method,uri,true);if(headers){for(header in headers){if(headers.hasOwnProperty(header)){request.setRequestHeader(header,headers[header])}}}if(typeof data==="string"){request.send(data)}else{request.send(null)}if(callback){request.onreadystatechange=function(){if(request.readyState!==4){return}callback(request)}}return request}if(window.opera!==undef){if(parseInt(window.opera.version(),10)===9){Event.prototype.__defineGetter__("origin",function(){return"http://"+this.domain})}}function pmxdrRequestHandler(evt){var data,optionsCorsHeaders,origin,source,reply;function sendReply(response){source.postMessage(JSON.stringify(response),origin)}function replyError(code){reply.error=code;sendReply(reply)}function handleResponse(request){var corsHeaders;if(request.readyState!==4){return}reply.status=request.status;reply.statusText=request.statusText;if(!request.status){replyError("LOAD_ERROR");return}if(request.status===1223){reply.status=204;reply.statusText="No Content";corsHeaders=optionsCorsHeaders}else{corsHeaders=getCorsHeaders(request)}if(!isTrustedOrigin(origin,corsHeaders.origin)){replyError("DISALLOWED_ORIGIN");return}if(!isAllowedMethod(data.method,corsHeaders.methods)){replyError("DISALLOWED_REQUEST_METHOD");return}reply.data=request.responseText;reply.headers=getAllHeaders(request);sendReply(reply)}source=evt.source;origin=evt.origin;try{data=JSON.parse(evt.data)}catch(e){return}if(typeof data!=="object"||data.pmxdr!==true){return}reply={pmxdr:true};if(data.id!==undef){reply.id=data.id}if(typeof data.method==="string"){data.method=data.method.toUpperCase()}makeRequest("OPTIONS",data.uri,data.headers,null,function(optionsRequest){optionsCorsHeaders=getCorsHeaders(optionsRequest);if(data.method==="OPTIONS"){handleResponse(optionsRequest);return}makeRequest(data.method,data.uri,data.headers,data.data,handleResponse)})}if(window.addEventListener){window.addEventListener("message",pmxdrRequestHandler,false)}else if(window.attachEvent){window.attachEvent("onmessage",pmxdrRequestHandler)}window.pmxdrRequestHandler=pmxdrRequestHandler})();